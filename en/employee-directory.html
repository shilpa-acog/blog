<!--
title: under-development
description: 
published: true
date: 2025-05-22T09:02:35.402Z
tags: 
editor: code
dateCreated: 2025-05-22T09:02:35.402Z
-->

'use client';

import { useEffect, useRef } from 'react';

// @ts-expect-error Typescript modules not available for molstar
import { Viewer } from 'molstar/build/viewer/molstar';

export default function MolstarViewer({ pdbText, artifactName }: { pdbText: string; artifactName: string }) {
  const viewerRef = useRef(null);
  const pluginRef = useRef(null);

  useEffect(() => {
    if (!viewerRef.current || pluginRef.current || !pdbText) return;

    const loadMolstar = async () => {
      try {
        // Step 1: Create the plugin viewer
        pluginRef.current = await Viewer.create(viewerRef.current, {
          layoutIsExpanded: false,
          layoutShowControls: false,
          layoutShowSequence: true,
          layoutShowLog: false,
          layoutShowLeftPanel: false,
        });

        // Reset body style to allow scrolling
        document.body.style.overflow = 'auto';
        document.body.style.position = 'static';
        document.documentElement.style.overflow = 'auto';

        // Step 2: Load structure from string data (MDX block or fetched)
        if (pluginRef.current) {
          // @ts-expect-error FIXME:
          await pluginRef.current?.loadStructureFromData(pdbText, 'pdb');
        } else {
          console.warn('pluginRef is not ready');
        }
      } catch (err) {
        console.error('[Molstar] Failed to load structure:', err);
      }
    };

    loadMolstar();
  }, [pdbText]);

  // Function to handle PDB file download
  const handleDownload = () => {
    const blob = new Blob([pdbText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${artifactName}.pdb`; // Use artifactName for filename
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  return (
    <section className="border p-4 rounded-xl my-6">
      <div
        ref={viewerRef}
        style={{
          width: '100%',
          height: '600px',
          position: 'relative',
          overflowX: 'hidden',
        }}
      />
      <div className="mt-4 flex justify-end">
        <button
          onClick={handleDownload}
          className="bg-blue-500 hover:bg-blue-700 text-white font-medium py-1 px-3 rounded text-sm flex items-center gap-2"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Download PDB
        </button>
      </div>
    </section>
  );
}